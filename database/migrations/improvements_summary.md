# ä»»åŠ¡ç®¡ç†ç³»ç»Ÿå››å¤§æ”¹è¿›è¯¦ç»†è¯´æ˜

## ğŸ“‹ æ”¹è¿›æ¦‚è§ˆ

| æ”¹è¿›é¡¹ | æ ¸å¿ƒé—®é¢˜ | è§£å†³æ–¹æ¡ˆ | æ–°å¢è¡¨/å­—æ®µ |
|--------|----------|----------|-------------|
| 1. å¤šéƒ¨é—¨è´Ÿè´£äºº | ä¸€äººä¸€éƒ¨é—¨é™åˆ¶ | å¤šå¯¹å¤šå…³è”è¡¨ | department_leaders è¡¨ |
| 2. å—é˜»çŠ¶æ€ç®¡ç† | æ— å—é˜»å¤„ç†æœºåˆ¶ | å—é˜»ä»»åŠ¡è¡¨ + çŠ¶æ€ | blocked_tasks è¡¨ + 2ä¸ªçŠ¶æ€ |
| 3. çŠ¶æ€æœºçº¦æŸ | çŠ¶æ€éšæ„è½¬æ¢ | è½¬æ¢è§„åˆ™è¡¨ + éªŒè¯ | task_status_transitions è¡¨ |
| 4. å®¡æ ¸æµç¨‹ä¼˜åŒ– | å®¡æ ¸å…³è”å¼± | å®¡æ ¸ä¼šè¯æœºåˆ¶ | review_sessions è¡¨ |

---

## ğŸ”§ æ”¹è¿›1ï¼šæ”¯æŒå¤šéƒ¨é—¨è´Ÿè´£äºº

### é—®é¢˜åˆ†æ
- **åŸè®¾è®¡**ï¼š`departments.leader_id` ä¸€å¯¹ä¸€å…³ç³»
- **é™åˆ¶**ï¼šä¸€ä¸ªäººåªèƒ½è´Ÿè´£ä¸€ä¸ªéƒ¨é—¨
- **å®é™…éœ€æ±‚**ï¼šé«˜ç®¡å¯èƒ½åŒæ—¶è´Ÿè´£å¤šä¸ªéƒ¨é—¨

### è§£å†³æ–¹æ¡ˆ

#### æ–°å¢è¡¨ï¼šdepartment_leadersï¼ˆéƒ¨é—¨è´Ÿè´£äººå…³è”è¡¨ï¼‰

```sql
CREATE TABLE department_leaders (
    department_id INTEGER,  -- éƒ¨é—¨ID
    user_id INTEGER,        -- è´Ÿè´£äººID
    is_primary BOOLEAN,     -- æ˜¯å¦ä¸»è¦è´Ÿè´£äºº
    appointed_at TIMESTAMP, -- ä»»å‘½æ—¶é—´
    UNIQUE(department_id, user_id)
);
```

#### æ•°æ®å…³ç³»

```
ç”¨æˆ· (User)
  â”œâ”€ è´Ÿè´£éƒ¨é—¨1 (ä¸»è¦è´Ÿè´£äºº)
  â”œâ”€ è´Ÿè´£éƒ¨é—¨2 (å‰¯èŒ)
  â””â”€ è´Ÿè´£éƒ¨é—¨3 (ä¸»è¦è´Ÿè´£äºº)

éƒ¨é—¨ (Department)
  â”œâ”€ è´Ÿè´£äºº1 (ä¸»è¦è´Ÿè´£äºº)
  â”œâ”€ è´Ÿè´£äºº2 (å‰¯èŒ)
  â””â”€ è´Ÿè´£äºº3 (å‰¯èŒ)
```

#### ä½¿ç”¨ç¤ºä¾‹

**åœºæ™¯ï¼šå¼ ä¸‰åŒæ—¶æ‹…ä»»æŠ€æœ¯éƒ¨ä¸»ç®¡å’Œäº§å“éƒ¨å‰¯èŒ**

```sql
-- ä»»å‘½å¼ ä¸‰ä¸ºæŠ€æœ¯éƒ¨ä¸»è¦è´Ÿè´£äºº
INSERT INTO department_leaders (department_id, user_id, is_primary, appointed_by)
VALUES (1, 5, TRUE, 1);

-- ä»»å‘½å¼ ä¸‰ä¸ºäº§å“éƒ¨å‰¯èŒ
INSERT INTO department_leaders (department_id, user_id, is_primary, appointed_by)
VALUES (2, 5, FALSE, 1);

-- æŸ¥è¯¢å¼ ä¸‰è´Ÿè´£çš„æ‰€æœ‰éƒ¨é—¨
SELECT * FROM v_user_departments WHERE user_id = 5;

-- æŸ¥è¯¢æŠ€æœ¯éƒ¨çš„æ‰€æœ‰è´Ÿè´£äºº
SELECT * FROM v_department_leaders_view WHERE department_id = 1;

-- è·¨éƒ¨é—¨ä»»åŠ¡æ ¡éªŒï¼šå¼ ä¸‰å¯ä»¥æ¥å—æŠ€æœ¯éƒ¨æˆ–äº§å“éƒ¨çš„è·¨éƒ¨é—¨ä»»åŠ¡
SELECT EXISTS (
    SELECT 1 FROM department_leaders 
    WHERE user_id = 5 AND department_id IN (1, 2)
) as can_accept_cross_dept_task;
```

#### ä¸šåŠ¡å½±å“

âœ… **ä»»åŠ¡æŒ‡æ´¾**ï¼šç³»ç»Ÿæ£€æŸ¥æ‰§è¡Œäººæ˜¯å¦ä¸ºç›®æ ‡éƒ¨é—¨çš„ä»»æ„è´Ÿè´£äºº
âœ… **æƒé™æ§åˆ¶**ï¼šè´Ÿè´£äººå¯æŸ¥çœ‹æ‰€è´Ÿè´£éƒ¨é—¨çš„æ‰€æœ‰ä»»åŠ¡
âœ… **çµæ´»æ€§**ï¼šæ”¯æŒç»„ç»‡æ¶æ„è°ƒæ•´

---

## ğŸš« æ”¹è¿›2ï¼šæ·»åŠ å—é˜»çŠ¶æ€å’Œå—é˜»ä»»åŠ¡ç®¡ç†

### é—®é¢˜åˆ†æ
- **åŸè®¾è®¡**ï¼šä»»åŠ¡åªæœ‰æ­£å¸¸æµè½¬çŠ¶æ€
- **å®é™…æƒ…å†µ**ï¼šä»»åŠ¡å¯èƒ½å› å„ç§åŸå› å—é˜»
- **éœ€æ±‚**ï¼šéœ€è¦è®°å½•å—é˜»åŸå› ã€åˆ›å»ºè§£å†³ä»»åŠ¡

### è§£å†³æ–¹æ¡ˆ

#### 2.1 æ–°å¢çŠ¶æ€

```sql
-- éœ€æ±‚ä»»åŠ¡å—é˜»çŠ¶æ€
INSERT INTO task_statuses VALUES ('req_blocked', 'å—é˜»', 'requirement', ...);

-- å•å…ƒä»»åŠ¡å—é˜»çŠ¶æ€  
INSERT INTO task_statuses VALUES ('unit_blocked', 'å—é˜»', 'unit_task', ...);
```

#### 2.2 æ–°å¢è¡¨ï¼šblocked_tasksï¼ˆå—é˜»ä»»åŠ¡è¡¨ï¼‰

```sql
CREATE TABLE blocked_tasks (
    task_id INTEGER,           -- è¢«é˜»å¡çš„ä»»åŠ¡
    blocked_reason TEXT,       -- å—é˜»åŸå› 
    blocker_type VARCHAR(50),  -- å—é˜»ç±»å‹
    blocking_task_id INTEGER,  -- é˜»å¡æ¥æºä»»åŠ¡
    resolution_task_id INTEGER,-- è§£å†³ä»»åŠ¡
    status VARCHAR(50),        -- open, in_progress, resolved
    reported_by INTEGER,       -- æŠ¥å‘Šäºº
    assigned_to INTEGER        -- æŒ‡æ´¾è§£å†³äºº
);
```

#### å—é˜»ç±»å‹ï¼ˆblocker_typeï¼‰

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `dependency` | ä¾èµ–é˜»å¡ | ç­‰å¾…å…¶ä»–ä»»åŠ¡å®Œæˆ |
| `resource` | èµ„æºä¸è¶³ | ç¼ºå°‘æ–‡æ¡£ã€ç¼ºå°‘æƒé™ |
| `technical` | æŠ€æœ¯éš¾é¢˜ | æŠ€æœ¯æ–¹æ¡ˆä¸å¯è¡Œ |
| `external` | å¤–éƒ¨å› ç´  | ç¬¬ä¸‰æ–¹å»¶æœŸã€æ”¿ç­–å˜åŒ– |

#### ä¸šåŠ¡æµç¨‹

```
1. ä»»åŠ¡æ‰§è¡Œä¸­é‡åˆ°é˜»å¡
   â†“
2. æ‰§è¡Œäººæ ‡è®°ä»»åŠ¡ä¸º"å—é˜»"
   â†“
3. åˆ›å»º blocked_tasks è®°å½•ï¼Œå¡«å†™åŸå› 
   â†“
4. ã€å¯é€‰ã€‘åˆ›å»ºè§£å†³ä»»åŠ¡ï¼ˆresolution_taskï¼‰
   â†“
5. è§£å†³ä»»åŠ¡è¿›å…¥æ­£å¸¸ä»»åŠ¡å¾ªç¯
   â†“
6. è§£å†³ä»»åŠ¡å®Œæˆåï¼ŒåŸä»»åŠ¡è§£é™¤å—é˜»
   â†“
7. åŸä»»åŠ¡çŠ¶æ€ä» blocked â†’ in_progress
```

#### ä½¿ç”¨ç¤ºä¾‹

**åœºæ™¯ï¼šä»»åŠ¡æ‰§è¡Œä¸­å‘ç°ç¼ºå°‘APIæ–‡æ¡£**

```sql
-- æ­¥éª¤1ï¼šæ ‡è®°ä»»åŠ¡ä¸ºå—é˜»
UPDATE tasks SET status_code = 'unit_blocked' WHERE id = 10;

-- æ­¥éª¤2ï¼šåˆ›å»ºå—é˜»è®°å½•
INSERT INTO blocked_tasks (
    task_id, blocked_reason, blocker_type, reported_by, status
)
VALUES (
    10, 
    'ç¼ºå°‘ç¬¬ä¸‰æ–¹æ”¯ä»˜APIæ–‡æ¡£ï¼Œæ— æ³•ç»§ç»­å¼€å‘', 
    'resource', 
    3,  -- æ‰§è¡ŒäººID
    'open'
);

-- æ­¥éª¤3ï¼šåˆ›å»ºè§£å†³ä»»åŠ¡
INSERT INTO tasks (
    task_no, title, task_type_code, status_code, 
    creator_id, executor_id, parent_task_id
)
VALUES (
    'UNIT-2024-050',
    'æ•´ç†ç¬¬ä¸‰æ–¹æ”¯ä»˜APIæ–‡æ¡£',
    'unit_task',
    'unit_draft',
    3,   -- æ‰§è¡Œäººåˆ›å»º
    5,   -- æŒ‡æ´¾ç»™æŠ€æœ¯è´Ÿè´£äºº
    10   -- çˆ¶ä»»åŠ¡ID
)
RETURNING id INTO @resolution_task_id;

-- æ­¥éª¤4ï¼šå…³è”è§£å†³ä»»åŠ¡
UPDATE blocked_tasks 
SET resolution_task_id = @resolution_task_id,
    assigned_to = 5,
    status = 'in_progress'
WHERE task_id = 10;

-- æ­¥éª¤5ï¼šè§£å†³ä»»åŠ¡å®Œæˆåï¼Œè‡ªåŠ¨è§£é™¤å—é˜»
-- è§¦å‘å™¨ä¼šè‡ªåŠ¨å¤„ç†ï¼š
-- - blocked_tasks.status â†’ 'resolved'
-- - tasks.status_code â†’ 'unit_in_progress'
```

#### è§¦å‘å™¨è‡ªåŠ¨åŒ–

```sql
-- ä»»åŠ¡çŠ¶æ€å˜ä¸ºå—é˜»æ—¶
CREATE TRIGGER handle_task_blocked
â†’ è®°å½•åˆ° task_change_logs
â†’ é€šçŸ¥ä»»åŠ¡åˆ›å»ºäºº

-- ä»»åŠ¡ä»å—é˜»æ¢å¤æ—¶  
CREATE TRIGGER handle_task_blocked
â†’ æ›´æ–° blocked_tasks.status = 'resolved'
â†’ è®°å½• resolved_at æ—¶é—´
```

---

## ğŸ” æ”¹è¿›3ï¼šå¢å¼ºçŠ¶æ€æœºçº¦æŸ

### é—®é¢˜åˆ†æ
- **åŸè®¾è®¡**ï¼šçŠ¶æ€å¯ä»¥éšæ„ä¿®æ”¹
- **é£é™©**ï¼šæ•°æ®ä¸ä¸€è‡´ã€ä¸šåŠ¡æµç¨‹æ··ä¹±
- **éœ€æ±‚**ï¼šä¸¥æ ¼æ§åˆ¶çŠ¶æ€è½¬æ¢è§„åˆ™

### è§£å†³æ–¹æ¡ˆ

#### 3.1 æ–°å¢è¡¨ï¼štask_status_transitionsï¼ˆçŠ¶æ€è½¬æ¢è§„åˆ™è¡¨ï¼‰

```sql
CREATE TABLE task_status_transitions (
    task_type_code VARCHAR(50),   -- ä»»åŠ¡ç±»å‹
    from_status_code VARCHAR(50), -- æºçŠ¶æ€
    to_status_code VARCHAR(50),   -- ç›®æ ‡çŠ¶æ€
    required_role VARCHAR(50),    -- éœ€è¦çš„è§’è‰²
    requires_approval BOOLEAN,    -- æ˜¯å¦éœ€è¦å®¡æ ¸
    is_allowed BOOLEAN,           -- æ˜¯å¦å…è®¸
    description TEXT              -- è¯´æ˜
);
```

#### 3.2 éœ€æ±‚ä»»åŠ¡çŠ¶æ€æœºå›¾

```
req_draft (è‰ç¨¿)
  â†“ [åˆ›å»ºäººå‘å¸ƒ]
req_pending_assign (å¾…é¢†æ± ) / req_pending_accept (å¾…æ¥å—)
  â†“ [æ‰§è¡Œäººæ¥å—]
req_pending_goal (å¾…æäº¤ç›®æ ‡)
  â†“ [æ‰§è¡Œäººæäº¤] â†’ [éœ€è¦å®¡æ ¸]
req_goal_review (ç›®æ ‡å®¡æ ¸ä¸­)
  â†“ [å®¡æ ¸é€šè¿‡]          â†“ [å®¡æ ¸é©³å›]
req_pending_plan          req_goal_rejected
  â†“ [æ‰§è¡Œäººæäº¤è®¡åˆ’]         â†“ [é‡æ–°æäº¤]
req_plan_review               req_pending_goal
  â†“ [å®¡æ ¸é€šè¿‡]
req_in_progress (æ‰§è¡Œä¸­)
  â†“ [å®Œæˆ] â† â†’ [å—é˜»] req_blocked
req_completed (å·²å®Œæˆ)
```

#### 3.3 è½¬æ¢è§„åˆ™ç¤ºä¾‹

| ä»çŠ¶æ€ | åˆ°çŠ¶æ€ | æ“ä½œäºº | éœ€è¦å®¡æ ¸ | è¯´æ˜ |
|--------|--------|--------|----------|------|
| draft | pending_assign | creator | å¦ | å‘å¸ƒåˆ°å¾…é¢†æ±  |
| pending_accept | pending_goal | executor | å¦ | æ‰§è¡Œäººæ¥å— |
| pending_goal | goal_review | executor | **æ˜¯** | æäº¤ç›®æ ‡å®¡æ ¸ |
| goal_review | pending_plan | reviewer | **æ˜¯** | å®¡æ ¸é€šè¿‡ |
| in_progress | blocked | executor | å¦ | æ ‡è®°å—é˜» |

#### 3.4 è§¦å‘å™¨éªŒè¯

```sql
CREATE TRIGGER validate_status_transition
BEFORE UPDATE OF status_code ON tasks
â†’ æ£€æŸ¥è½¬æ¢è§„åˆ™è¡¨
â†’ å¦‚æœä¸å…è®¸ â†’ RAISE EXCEPTION
â†’ å¦‚æœå…è®¸ â†’ è®°å½•æ—¥å¿—
```

#### ä½¿ç”¨ç¤ºä¾‹

**åœºæ™¯ï¼šæ‰§è¡Œäººå°è¯•å°†ä»»åŠ¡ä»è‰ç¨¿ç›´æ¥æ”¹ä¸ºå®Œæˆï¼ˆä¸å…è®¸ï¼‰**

```sql
-- å°è¯•éæ³•è½¬æ¢
UPDATE tasks 
SET status_code = 'req_completed' 
WHERE id = 1 AND status_code = 'req_draft';

-- è§¦å‘å™¨æŠ›å‡ºå¼‚å¸¸ï¼š
ERROR: ä¸å…è®¸çš„çŠ¶æ€è½¬æ¢: requirement ä» req_draft åˆ° req_completed
```

**åœºæ™¯ï¼šæŸ¥è¯¢å½“å‰ç”¨æˆ·å¯ä»¥æ‰§è¡Œçš„çŠ¶æ€è½¬æ¢**

```sql
-- æŸ¥è¯¢ä»»åŠ¡ID=1ï¼Œç”¨æˆ·ID=5 å¯ä»¥æ‰§è¡Œçš„çŠ¶æ€è½¬æ¢
SELECT * FROM get_allowed_transitions(1, 5);

-- è¿”å›ç»“æœï¼š
| to_status_code | to_status_name | required_role | requires_approval | description |
|----------------|----------------|---------------|-------------------|-------------|
| req_goal_review| ç›®æ ‡å®¡æ ¸ä¸­     | executor      | true              | æäº¤ç›®æ ‡å®¡æ ¸ |
| req_blocked    | å—é˜»           | executor      | false             | æ ‡è®°å—é˜»     |
```

#### ä¼˜åŠ¿

âœ… **æ•°æ®å®Œæ•´æ€§**ï¼šæœç»éæ³•çŠ¶æ€è½¬æ¢
âœ… **æƒé™æ§åˆ¶**ï¼šä¸åŒè§’è‰²åªèƒ½æ‰§è¡Œç‰¹å®šè½¬æ¢
âœ… **å®¡è®¡è¿½è¸ª**ï¼šæ‰€æœ‰è½¬æ¢éƒ½æœ‰æ—¥å¿—è®°å½•
âœ… **çµæ´»é…ç½®**ï¼šå¯é€šè¿‡ä¿®æ”¹è§„åˆ™è¡¨è°ƒæ•´æµç¨‹

---

## âœ… æ”¹è¿›4ï¼šå®¡æ ¸æµç¨‹ä¼˜åŒ–

### é—®é¢˜åˆ†æ

#### åŸè®¾è®¡çš„é—®é¢˜

1. **å…³è”å¼±**ï¼š`review_records.target_id` åªæ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä¸çŸ¥é“å…³è”åˆ°å“ªä¸ªè¡¨
2. **æ•°æ®ä¸ä¸€è‡´**ï¼šå®¡æ ¸è®°å½•å’Œè¢«å®¡æ ¸å¯¹è±¡çŠ¶æ€å¯èƒ½ä¸åŒæ­¥
3. **ç¼ºå°‘æµç¨‹ç®¡ç†**ï¼šå¤šäººå®¡æ ¸æ—¶æ— æ³•åè°ƒ
4. **å†³ç­–æ··ä¹±**ï¼šä¸æ¸…æ¥šè°åšæœ€ç»ˆå†³ç­–

### è§£å†³æ–¹æ¡ˆæ¶æ„

```
å®¡æ ¸æµç¨‹æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   review_sessions (å®¡æ ¸ä¼šè¯è¡¨)           â”‚
â”‚   - ç®¡ç†æ•´ä¸ªå®¡æ ¸æµç¨‹                      â”‚
â”‚   - è®°å½•å®¡æ ¸ç±»å‹ã€è¢«å®¡æ ¸å¯¹è±¡              â”‚
â”‚   - è®°å½•æœ€ç»ˆå†³ç­–                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ 1:N
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   review_records (å®¡æ ¸è®°å½•è¡¨)            â”‚
â”‚   - æ¯ä¸ªå®¡æ ¸äººçš„æ„è§                      â”‚
â”‚   - æŠ•ç¥¨ã€è¯„åˆ†ã€è¯„è®º                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.1 æ–°å¢è¡¨ï¼šreview_sessionsï¼ˆå®¡æ ¸ä¼šè¯è¡¨ï¼‰

```sql
CREATE TABLE review_sessions (
    id SERIAL PRIMARY KEY,
    task_id INTEGER,              -- ä»»åŠ¡ID
    review_type VARCHAR(50),      -- å®¡æ ¸ç±»å‹
    target_type VARCHAR(50),      -- è¢«å®¡æ ¸å¯¹è±¡çš„è¡¨å
    target_id INTEGER,            -- è¢«å®¡æ ¸å¯¹è±¡çš„ID
    
    -- å®¡æ ¸æ¨¡å¼
    review_mode VARCHAR(50),      -- single/jury
    required_approvals INTEGER,   -- éœ€è¦çš„é€šè¿‡ç¥¨æ•°
    
    -- æœ€ç»ˆå†³ç­–ï¼ˆç”±åˆ›å»ºäººç¡®å®šï¼‰
    final_decision VARCHAR(50),   -- approved/rejected
    final_decision_by INTEGER,    -- å†³ç­–äºº
    final_decision_at TIMESTAMP,  -- å†³ç­–æ—¶é—´
    final_decision_comment TEXT,  -- å†³ç­–è¯´æ˜
    
    status VARCHAR(50)            -- pending/in_review/approved/rejected
);
```

#### å…³é”®å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `target_type` | VARCHAR | è¢«å®¡æ ¸å¯¹è±¡çš„è¡¨åï¼š`requirement_goals`ã€`requirement_solutions`ã€`execution_plans` |
| `target_id` | INTEGER | è¢«å®¡æ ¸å¯¹è±¡åœ¨è¯¥è¡¨ä¸­çš„ID |
| `review_mode` | VARCHAR | `single`-å•äººå®¡æ ¸ï¼ˆåˆ›å»ºäººï¼‰ã€`jury`-é™ªå®¡å›¢å®¡æ ¸ï¼ˆå¤šäººæŠ•ç¥¨ï¼‰ |
| `final_decision` | VARCHAR | æœ€ç»ˆå†³ç­–ç”±**ä»»åŠ¡åˆ›å»ºäºº**ç¡®å®š |

### 4.2 é‡æ„ï¼šreview_recordsï¼ˆå®¡æ ¸è®°å½•è¡¨ï¼‰

```sql
CREATE TABLE review_records (
    review_session_id INTEGER,  -- å…³è”åˆ°å®¡æ ¸ä¼šè¯
    reviewer_id INTEGER,        -- å®¡æ ¸äºº
    reviewer_role VARCHAR(50),  -- creator/jury/expert
    opinion VARCHAR(50),        -- approve/reject/abstain
    comment TEXT,               -- å®¡æ ¸æ„è§
    score INTEGER,              -- è¯„åˆ†1-5
    vote_weight DECIMAL(3,2),   -- æŠ•ç¥¨æƒé‡
    UNIQUE(review_session_id, reviewer_id)
);
```

### 4.3 å®¡æ ¸æµç¨‹å¯¹æ¯”

#### å•äººå®¡æ ¸æ¨¡å¼ï¼ˆSingleï¼‰

```
æ‰§è¡Œäººæäº¤ç›®æ ‡
  â†“
åˆ›å»ºå®¡æ ¸ä¼šè¯ (review_mode = 'single')
  â†“
åˆ›å»ºäººå®¡æ ¸
  â†“
åˆ›å»ºäººæäº¤æ„è§ â†’ ç›´æ¥ä½œä¸ºæœ€ç»ˆå†³ç­–
  â†“
æ›´æ–°ä»»åŠ¡çŠ¶æ€
```

#### é™ªå®¡å›¢å®¡æ ¸æ¨¡å¼ï¼ˆJuryï¼‰

```
æ‰§è¡Œäººæäº¤ç›®æ ‡
  â†“
åˆ›å»ºå®¡æ ¸ä¼šè¯ (review_mode = 'jury')
  â†“
é‚€è¯·é™ªå®¡å›¢æˆå‘˜ï¼ˆ3-5äººï¼‰
  â†“
å„é™ªå®¡å›¢æˆå‘˜æäº¤æ„è§
  â”œâ”€ å¼ ä¸‰ï¼šapprove (4åˆ†)
  â”œâ”€ æå››ï¼šapprove (5åˆ†)
  â””â”€ ç‹äº”ï¼šreject (2åˆ†)
  â†“
åˆ›å»ºäººæŸ¥çœ‹æ‰€æœ‰æ„è§
  â†“
åˆ›å»ºäººåšæœ€ç»ˆå†³ç­– â† å…³é”®ï¼
  - å¯ä»¥é‡‡çº³å¤šæ•°æ„è§
  - ä¹Ÿå¯ä»¥å¦å†³å¤šæ•°æ„è§
  â†“
æ›´æ–°ä»»åŠ¡çŠ¶æ€
```

### 4.4 æ•°æ®ä¸€è‡´æ€§ä¿è¯

#### æœºåˆ¶1ï¼šå¤–é”®çº¦æŸ

```sql
review_sessions.target_id â†’ å¤–é”®çº¦æŸ
  - åˆ é™¤è¢«å®¡æ ¸å¯¹è±¡æ—¶ï¼Œçº§è”åˆ é™¤å®¡æ ¸ä¼šè¯
```

#### æœºåˆ¶2ï¼šè§¦å‘å™¨åŒæ­¥

```sql
CREATE TRIGGER update_review_target_status
AFTER UPDATE ON review_sessions
â†’ æœ€ç»ˆå†³ç­–ç¡®å®šå
â†’ è‡ªåŠ¨æ›´æ–°è¢«å®¡æ ¸å¯¹è±¡çš„statuså­—æ®µ
â†’ ä¿è¯çŠ¶æ€ä¸€è‡´
```

#### æœºåˆ¶3ï¼šäº‹åŠ¡ä¿è¯

```sql
BEGIN TRANSACTION;

-- 1. æ›´æ–°å®¡æ ¸ä¼šè¯
UPDATE review_sessions SET final_decision = 'approved';

-- 2. æ›´æ–°è¢«å®¡æ ¸å¯¹è±¡
UPDATE requirement_goals SET status = 'approved';

-- 3. æ›´æ–°ä»»åŠ¡çŠ¶æ€
UPDATE tasks SET status_code = 'req_pending_plan';

COMMIT;
```

### 4.5 ä½¿ç”¨ç¤ºä¾‹

#### åœºæ™¯ï¼šç›®æ ‡å®¡æ ¸ï¼ˆé™ªå®¡å›¢æ¨¡å¼ï¼‰

```sql
-- æ­¥éª¤1ï¼šæ‰§è¡Œäººæäº¤ç›®æ ‡åï¼Œåˆ›å»ºå®¡æ ¸ä¼šè¯
INSERT INTO review_sessions (
    task_id, review_type, target_type, target_id,
    initiated_by, review_mode, required_approvals
)
VALUES (
    1,                    -- ä»»åŠ¡ID
    'goal_review',        -- ç›®æ ‡å®¡æ ¸
    'requirement_goals',  -- è¢«å®¡æ ¸å¯¹è±¡è¡¨å
    5,                    -- ç›®æ ‡ID
    3,                    -- æ‰§è¡ŒäººID
    'jury',               -- é™ªå®¡å›¢æ¨¡å¼
    2                     -- éœ€è¦2ç¥¨é€šè¿‡
)
RETURNING id INTO @session_id;

-- æ­¥éª¤2ï¼šé‚€è¯·é™ªå®¡å›¢æˆå‘˜
INSERT INTO task_participants (task_id, user_id, role, invited_by)
VALUES 
    (1, 5, 'jury', 1),  -- å¼ ä¸‰
    (1, 6, 'jury', 1),  -- æå››
    (1, 7, 'jury', 1);  -- ç‹äº”

-- æ­¥éª¤3ï¼šé™ªå®¡å›¢æˆå‘˜æäº¤æ„è§
INSERT INTO review_records (
    review_session_id, reviewer_id, reviewer_role,
    opinion, comment, score
)
VALUES 
    (@session_id, 5, 'jury', 'approve', 'ç›®æ ‡æ˜ç¡®', 4),
    (@session_id, 6, 'jury', 'approve', 'æ–¹æ¡ˆå¯è¡Œ', 5),
    (@session_id, 7, 'jury', 'reject', 'èµ„æºä¸è¶³', 2);

-- æ­¥éª¤4ï¼šæŸ¥çœ‹å®¡æ ¸ç»Ÿè®¡
SELECT * FROM v_review_session_stats WHERE session_id = @session_id;

-- è¿”å›ï¼š
| approve_count | reject_count | average_score |
|---------------|--------------|---------------|
| 2             | 1            | 3.67          |

-- æ­¥éª¤5ï¼šåˆ›å»ºäººåšæœ€ç»ˆå†³ç­–
SELECT finalize_review_decision(
    @session_id,           -- å®¡æ ¸ä¼šè¯ID
    1,                     -- åˆ›å»ºäººID
    'approved',            -- å†³ç­–ï¼šé€šè¿‡
    'è™½ç„¶æœ‰ä¸€ç¥¨åå¯¹ï¼Œä½†å¤šæ•°è®¤å¯ï¼Œèµ„æºé—®é¢˜å¯ä»¥åè°ƒè§£å†³'
);

-- è‡ªåŠ¨æ‰§è¡Œï¼š
-- 1. review_sessions.final_decision = 'approved'
-- 2. requirement_goals.status = 'approved'
-- 3. tasks.status_code = 'req_pending_plan'
-- 4. é€šçŸ¥æ‰§è¡Œäººï¼š"ç›®æ ‡å®¡æ ¸å·²é€šè¿‡"
```

### 4.6 ä¼˜åŠ¿æ€»ç»“

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **å¼ºå…³è”** | `target_type` + `target_id` æ˜ç¡®æŒ‡å‘è¢«å®¡æ ¸å¯¹è±¡ |
| **æ•°æ®ä¸€è‡´** | è§¦å‘å™¨ä¿è¯å®¡æ ¸çŠ¶æ€ä¸å¯¹è±¡çŠ¶æ€åŒæ­¥ |
| **æµç¨‹æ¸…æ™°** | å®¡æ ¸ä¼šè¯ç®¡ç†æ•´ä¸ªæµç¨‹ |
| **å†³ç­–æƒæ˜ç¡®** | åˆ›å»ºäººæ‹¥æœ‰æœ€ç»ˆå†³ç­–æƒ |
| **æ”¯æŒæŠ•ç¥¨** | é™ªå®¡å›¢æ¨¡å¼æ”¯æŒå¤šäººè¯„å®¡ |
| **å®¡è®¡å®Œæ•´** | æ‰€æœ‰å®¡æ ¸æ„è§éƒ½æœ‰è®°å½• |

---

## ğŸ“Š å››å¤§æ”¹è¿›çš„ååŒæ•ˆæœ

### å®Œæ•´ä¸šåŠ¡åœºæ™¯æ¼”ç¤º

**åœºæ™¯ï¼šè·¨éƒ¨é—¨éœ€æ±‚ä»»åŠ¡ï¼Œé™ªå®¡å›¢å®¡æ ¸ï¼Œæ‰§è¡Œä¸­å—é˜»**

```
1. åˆ›å»ºè·¨éƒ¨é—¨éœ€æ±‚ä»»åŠ¡
   - äº§å“éƒ¨å‘èµ·ï¼ŒæŒ‡æ´¾æŠ€æœ¯éƒ¨è´Ÿè´£äºº
   - æ£€æŸ¥ï¼šæŠ€æœ¯éƒ¨è´Ÿè´£äºº (department_leadersè¡¨)
   - è®¾ç½®ï¼šis_cross_department = TRUE

2. æ‰§è¡Œäººæäº¤ç›®æ ‡å’Œæ–¹æ¡ˆ
   - åˆ›å»ºå®¡æ ¸ä¼šè¯ (review_mode = 'jury')
   - é‚€è¯·3åä¸“å®¶ä½œä¸ºé™ªå®¡å›¢
   
3. é™ªå®¡å›¢å®¡æ ¸
   - 3äººæäº¤æ„è§ï¼š2 approve, 1 reject
   - åˆ›å»ºäººæŸ¥çœ‹ç»Ÿè®¡ï¼Œåšæœ€ç»ˆå†³ç­–ï¼šapproved
   - è§¦å‘å™¨æ›´æ–°ï¼šç›®æ ‡çŠ¶æ€ã€ä»»åŠ¡çŠ¶æ€

4. æ‰§è¡Œäººæäº¤æ‰§è¡Œè®¡åˆ’
   - å†æ¬¡å®¡æ ¸ï¼ˆå•äººæˆ–é™ªå®¡å›¢ï¼‰
   - å®¡æ ¸é€šè¿‡ï¼Œå¼€å§‹æ‹†åˆ†å­ä»»åŠ¡

5. æ‰§è¡Œä¸­é‡åˆ°é˜»å¡
   - æ ‡è®°ä¸ºå—é˜» (req_blocked)
   - è®°å½•å—é˜»åŸå› ï¼šdependencyç±»å‹
   - åˆ›å»ºè§£å†³ä»»åŠ¡ï¼ŒæŒ‡æ´¾ç»™å…¶ä»–äºº

6. è§£å†³ä»»åŠ¡å®Œæˆ
   - è‡ªåŠ¨è§£é™¤åŸä»»åŠ¡å—é˜»çŠ¶æ€
   - åŸä»»åŠ¡ç»§ç»­æ‰§è¡Œ

7. å°è¯•éæ³•çŠ¶æ€è½¬æ¢
   - è§¦å‘å™¨æ‹¦æˆªï¼ŒæŠ›å‡ºå¼‚å¸¸
   - ä¿è¯æµç¨‹è§„èŒƒ
```

## ğŸ¯ æ€»ç»“

å››å¤§æ”¹è¿›å®Œç¾ååŒï¼Œæ„å»ºäº†ä¸€ä¸ªï¼š
- âœ… **çµæ´»çš„ç»„ç»‡æ¶æ„**ï¼ˆå¤šéƒ¨é—¨è´Ÿè´£äººï¼‰
- âœ… **å®Œå–„çš„å¼‚å¸¸å¤„ç†**ï¼ˆå—é˜»ä»»åŠ¡ç®¡ç†ï¼‰
- âœ… **ä¸¥æ ¼çš„æµç¨‹æ§åˆ¶**ï¼ˆçŠ¶æ€æœºçº¦æŸï¼‰
- âœ… **å¯é çš„å®¡æ ¸æœºåˆ¶**ï¼ˆå®¡æ ¸ä¼šè¯+æœ€ç»ˆå†³ç­–ï¼‰

è¿™äº›æ”¹è¿›å…±åŒä¿è¯äº†ç³»ç»Ÿçš„**æ•°æ®ä¸€è‡´æ€§**ã€**ä¸šåŠ¡å®Œæ•´æ€§**å’Œ**æµç¨‹è§„èŒƒæ€§**ï¼