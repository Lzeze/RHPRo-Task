# 实施计划

- [-] 1. 扩展Service层 - StatusTransitionService
  - 实现GetStatusesByTaskType方法，支持按任务类型查询状态列表
  - 实现GetTaskAllowedTransitions增强方法，基于任务上下文获取允许的转换
  - 添加必要的辅助方法和数据结构
  - _需求: 1.1, 1.2, 2.1, 2.2, 2.3_

- [ ] 1.1 编写属性测试 - 状态列表完整性和排序
  - **属性 1: 状态列表完整性和排序**
  - **验证：需求 1.1, 1.3**

- [-] 1.2 编写属性测试 - 不存在类型的优雅处理
  - **属性 2: 不存在类型的优雅处理**
  - **验证：需求 1.2**

- [x] 2. 扩展Service层 - TaskService辅助方法
  - 实现GetTaskContext方法，获取任务的上下文信息（类型、状态、创建人、执行人）
  - 添加任务存在性验证
  - _需求: 2.1, 2.5_

- [ ] 2.1 编写属性测试 - 任务上下文获取正确性
  - **属性 3: 任务上下文获取正确性**
  - **验证：需求 2.1**

- [x] 3. 创建DTO层数据结构
  - 在dto/TaskFlowDto.go中添加AllowedTransitionDto结构
  - 添加TaskContext结构用于内部数据传递
  - _需求: 2.4_

- [x] 4. 实现Controller层 - TaskFlowController
  - 实现GetTaskStatuses方法，处理状态列表查询请求
  - 实现GetTaskAllowedTransitions方法，处理任务转换查询请求
  - 添加参数验证和错误处理
  - 从JWT token中提取当前用户ID
  - _需求: 1.1, 1.2, 1.3, 1.4, 2.1-2.6_

- [ ] 4.1 编写属性测试 - 用户角色识别正确性
  - **属性 4: 用户角色识别正确性**
  - **验证：需求 2.2**

- [ ] 4.2 编写属性测试 - 转换规则综合过滤
  - **属性 5: 转换规则综合过滤**
  - **验证：需求 2.3, 2.6, 3.4**

- [ ] 4.3 编写属性测试 - 转换信息完整性
  - **属性 6: 转换信息完整性**
  - **验证：需求 2.4**

- [ ] 4.4 编写属性测试 - 终态状态正常处理
  - **属性 7: 终态状态正常处理**
  - **验证：需求 3.2**

- [x] 5. 配置路由
  - 在routes/routes.go中添加新的API端点
  - GET /api/v1/task-flow/statuses - 获取任务状态列表
  - GET /api/v1/task-flow/tasks/:task_id/allowed-transitions - 获取任务允许的状态转换
  - 配置认证中间件
  - _需求: 所有需求_

- [ ] 5.1 编写单元测试 - Controller层
  - 测试GetTaskStatuses的各种场景（有效类型、空类型、不存在类型）
  - 测试GetTaskAllowedTransitions的各种场景（创建人、执行人、普通用户、任务不存在）
  - 测试边界情况（执行人为空、终态状态、数据库错误）
  - _需求: 1.1-1.4, 2.1-2.6, 3.1-3.4_

- [ ] 6. 更新Swagger文档
  - 在docs/docs.go中添加新API的Swagger注释
  - 重新生成swagger.json和swagger.yaml
  - _需求: 所有需求_

- [ ] 7. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 8. 集成测试
  - 编写端到端集成测试
  - 测试完整的请求-响应流程
  - 验证与数据库的交互
  - 测试认证和授权中间件
  - _需求: 所有需求_
